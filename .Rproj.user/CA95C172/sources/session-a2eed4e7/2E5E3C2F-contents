---
#title: "Step 1: Submit the Itembank"
---

```{=html}
<script>
 function postFiles() {
  const key = document.getElementById("key").value;
  const catName = document.getElementById("catName").value;
  const url = "https://qualcat.duckdns.org/api/v0/upload";

  const itemBank = document.getElementById("itemBankInput").files[0];
  //const rawData = document.getElementById("rawDataInput").files[0];
console.log(catName)
  const formData = new FormData();
  if (itemBank) formData.append("file", itemBank);
  //if (rawData) formData.append("rawData", rawData);
  
  fetch(url, {
    method: 'POST',
    headers: { "x-api-key": key,
              "catName": catName 
    },
    body: formData
  })
  .then(async response => {
    if (!response.ok) {
      const errMsg = await response.text();
      throw new Error(`HTTP ${response.status}: ${errMsg}`);
    }
    return response.json();
  })
  .then(data => alert("Files uploaded successfully!"))
  .catch(err => alert("Error: " + err));
}

</script>
```
Once you have filled in the actual data in the itembank, you can use the field below to upload your itembank to the server.

```{=html}
<div style="
  background-color: rgba(24, 188, 156, 0.1);  /* #18bc9c with 20% opacity */
  border: 1px solid #18bc9c;
  display: flex;
  justify-content: center;
  padding: 20px;
">
  <div class="d-flex flex-column" style="gap: 12px; max-width: 400px;">
    <div>
      <label for="formFile" class="form-label mt-2">Select Itembank File (.csv format)</label>
      <input class="form-control" type="file" id="itemBankInput" accept=".csv"> 
    </div>

    <!--<legend class="mt-2"></legend>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="rawDataToggle" onchange="toggleRawDataInput()">
      <label class="form-check-label" for="rawDataToggle">Raw data available</label>
    </div>

    <div id="rawDataContainer" style="display: none;">
      <label for="rawDataInput" class="form-label mt-4">Select Raw Data File</label>
      <input class="form-control" type="file" id="rawDataInput" accept=".Rdata"> 
    </div>

    <div class="form-floating mt-2">
      <input type="password" class="form-control" id="key" placeholder="Personal Key" autocomplete="off">
      <label for="key">Personal Key</label>
    </div> -->

    <button class="btn btn-outline-success mt-2" onclick="postFiles()">
      Submit File
    </button>
  </div>
</div>
```
```{=html}
<!--<script>
  function toggleRawDataInput() {
    const checkbox = document.getElementById("rawDataToggle");
    const rawDataContainer = document.getElementById("rawDataContainer");
    rawDataContainer.style.display = checkbox.checked ? "block" : "none";
  }
</script>-->
```
For the purpose of this tutorial, you can use the `R` code below to create an itembank with polytomous items, or use [**this file**](https://osf.io/ymh3d/files/sk9hx) for an English-Dutch vocabulary test, which includes 36 dichotomous items.

::: {.panel-tabset group="language"}
## Details for the itembank structure

The item bank must be a `.csv` (Comma-Separated Values) file, with specific column names and structure. The number of rows should correspond to the number of available items.

-   One column must contain the item labels, labelled `ItemLabel`.

-   A second column must contain the item texts, labelled `Item`.

-   Subsequent columns must contain the response options, labeled `Choice1`, `Choice2`, and so on, up to the number of available choices.\
    **Note:** In this version, all items must have the same number of response options.

-   One column labelled `Scores` must contain the item scores. A possible format for a dichotomous itemwith 4 response options could be `0100` indicating that the second response option scored as 1 (e.g., correct answer). For polytomous items the scores should range from `0` up to the total number o categories minus 1, e.g., `0123` for 4 response options.

-   Subsequent columns started with the letter `a` correspond to the IRT discrimination (slope) parameters.\
    For a unidimensional structure, there is only one parameter, labelled `a1.`\
    For multidimensional structures, `a1` corresponds to the first factor, `a2` to the second factor, and so on.

-   Similarly, columns started with the letter labeled `d` correspond to the IRT difficulty (location or intercept) parameters.\
    For a unidimensional structure, there is only one parameter, labelled `d.`\
    For multidimensional structures, `d1` corresponds to the first threshold, `d2` to the second threshold, and so on, up to the number of available thresholds.

## Example itembank in `R`

In this example we create an itembank for the PHQ-9 questionnaire. The PHQ-9 consists of nine items measuring depression symptoms with four ordered response options. The items have been calibrated using publicly available data with a Graded Response Model.

```{r, eval = FALSE, echo = TRUE}
wd <- '[PATH TO YOUR WORKING DIRECTORY]' # replace this with your working directory
# read the blueprint item bank:
item_bank <- read.csv(file.path(wd, "itembank_blueprint.csv"), colClasses = c(Scores = "character"))

# We fill in the columns manually columnwise:
item_bank$ItemLabel <- c("DPQ010", "DPQ020", "DPQ030", "DPQ040", "DPQ050", "DPQ060", "DPQ070", "DPQ080", "DPQ090")
item_bank$Item <- c(
  "Over the last 2 weeks, how often have you been bothered by little interest or pleasure in doing things",
  "Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless",
  "Over the last 2 weeks, how often have you been bothered by trouble falling or staying asleep, or sleeping too much",
  "Over the last 2 weeks, how often have you been bothered by feeling tired or having little energy",
  "Over the last 2 weeks, how often have you been bothered by poor appetite or overeating",
  "Over the last 2 weeks, how often have you been bothered by feeling bad about yourself or that you are a failure or have let yourself or your family down",
  "Over the last 2 weeks, how often have you been bothered by trouble concentrating on things, such as reading the newspaper or watching television",
  "Over the last 2 weeks, how often have you been bothered by moving or speaking so slowly that other people could have noticed. Or the opposite being so figety or restless that you have been moving around a lot more than usual",
  "Over the last 2 weeks, how often have you been bothered by thoughts that you would be better off dead, or of hurting yourself"
)

# In this example all questions have the same answer options
answer_options <- c("Not at all", "Several days", "More than half the days", "Nearly every day")
# We assign this options to the correct columns
item_bank[, 3:6] <- t(apply(item_bank[, 3:6], 1, function(x) answer_options))

# adding discrimination parameter values manually
item_bank$a1 <- c(2.424091, 3.122244, 1.632741, 1.974066,
                  1.880244, 2.759441, 2.202966, 2.103382,
                  2.303624)
# adding location/difficulty parameter values manually
# Note: for a "graded" model should be ordered within each item
item_bank$d1 <- c(2.08369022, -2.48929807, -0.70986867, -0.07750205,
                  -1.77299047, -3.06577563, -2.62351599, -3.37522945,
                  -5.17894765)
item_bank$d2 <- c(-4.309610, -5.251526, -2.414099, -2.630950,
                  -3.472991, -5.215560, -4.455207, -4.905570,
                  -6.706078)
item_bank$d3 <- c(-5.602148, -6.673016, -3.288573, -3.694516,
                  -4.441030, -6.354125, -5.359964, -5.962049,
                  -7.498389)
# save the item bank
write.csv(item_bank, file.path(wd, "itembank.csv"), row.names = FALSE, quote = TRUE)
# END
```
:::
